---
title: "Lifetime"
author: "Rodica Coderie"
date: "Sunday, January 24, 2016"
output: html_document
---

This is a draft of an analysis that will help us better understand what influences lifetime of an user.
It contains exploratory analysis of the features included in the train sample. Also, at the end, there are some conclusions and proposed next steps.

```{r}
setwd("C:/Users/rodica.coderie/Documents/Rodica/SIEN")
```
##### exploring the summary data
```{r}
summaryTrain<- read.csv("summaryTrain.csv", header = T)
head(summaryTrain)
names(summaryTrain)
nrow(summaryTrain)
ncol(summaryTrain)
str(summaryTrain)
head(summaryTrain)
tail(summaryTrain)
table(summaryTrain$country_code)
table(summaryTrain$os)
library(dplyr)
select(summaryTrain, country_code) %>% unique %>% nrow
summary(summaryTrain$no_features)
```
###### Top 10 countries ordered desc by the no of users
```{r}
ranking <- group_by(summaryTrain, country_code) %>%
  summarize(usersN = sum(users)) %>%
  as.data.frame %>%
  arrange(desc(usersN))
head(ranking,10)
```
#### Questions
##### 1. Which countries generate the majority of events?
##### 2. Is the average lifetime influenced by the no of events?
##### 3. Is the no of times a features has been active correlated with the no of websites?

```{r}
TrainData<- read.csv("train2.csv", header = T)
# basic statistic about the training data
dim(TrainData)
class(TrainData)
names(TrainData)
head(TrainData)
nrow(TrainData)
ncol(TrainData)
str(TrainData)

## extract version
substrLast <- function(x, n){
  substr(x, nchar(x)-n+1, nchar(x)-1)
}
substrLast(as.character(head(TrainData$os)), 2)

is.null(TrainData[TrainData$userid=='00095067-A385-42A4-91B7-0CE49AFBE0D2',]$os)
TrainData[TrainData$userid=='00095067-A385-42A4-91B7-0CE49AFBE0D2',]$os=='NULL'
nrow(TrainData[TrainData$os=='NULL',])

#remove NULL os values from training data
TrainData <- TrainData[!(TrainData$os=='NULL'),]
select(TrainData, userid) %>% unique %>% nrow

#adding os version
TrainData$os_version <- as.factor(substrLast(as.character(TrainData$os), 2))
```

##### exploratory graphs analysis
```{r}
summary(TrainData$range)
fivenum(TrainData$range)

boxplot(TrainData$range, col="blue")
abline(h=10.27)
#no outliners

summary(TrainData$no_website)
fivenum(TrainData$no_website)
boxplot(TrainData$no_website, col="red")
abline(h=24.52)
#some outliners over 1000
filter(TrainData, no_website > 1000)


hist(TrainData$range, col="green")
rug(TrainData$range)
abline(v=10.27, lwd=2)
abline(v=median(TrainData$range), col="magenta", lwd=4)

#relationship between os_version and no of users
barplot(table(TrainData$os_version), col="wheat", main="No of users in each win version")
# most popular versions are 4 and 5

#relationship between os_version and lifetime
boxplot(range ~ os_version, data = TrainData, col = "red")


# relationship between lifetime and no of events
with(TrainData, plot(range, no_events))
 abline(h = 12, lwd = 2, lty = 2)

# relationship between no_websites and active features
with(TrainData, plot(no_website, active_features))
abline(h = 12, lwd = 2, lty = 2)

with(TrainData, plot(range, no_events, col = os_version))
abline(h = 12, lwd = 2, lty = 2)

#Multiple Scatterplots
par(mfrow = c(2, 2), mar = c(5, 4, 2, 1))
with(subset(TrainData, os_version == '6'), plot(range, no_website, main = "Version 6"))
with(subset(TrainData, os_version == '5'), plot(range, no_website, main = "Version 5"))
with(subset(TrainData, os_version == '4'), plot(range, no_website, main = "Version 4"))
with(subset(TrainData, os_version == '2'), plot(range, no_website, main = "Version 2"))
```
##### Trying clustering and corellation to understand relationships
```{r}
#clustering the data using kmeans
set.seed(1234)
kmeansObj <- kmeans(TrainData[,c(3:6)], centers=3)
names(kmeansObj)
kmeansObj$size
kmeansObj$centers


set.seed(1234)
kmeansObj <- kmeans(TrainData[,c(3:6)], centers=5)
names(kmeansObj)
kmeansObj$size
kmeansObj$centers

# Pearson correlation
cor(TrainData[,c(3:6)], use="complete.obs")
#cor(TrainData[,c(3:6)], use="complete.obs", method="kendall")

# check correlation between lifetime and os version
model.lm <- lm(TrainData$range ~ TrainData$os_version, data = TrainData)
summary(model.lm)
# version2 has a lifetime with 3.76 days smaller than the estimated intercept (we can consider intercept as average lifetime)
# version6 has a iifetime with 2.8 days larger than the estimated intercept
# we can see this variation also in the boxplots above
# still, becase R-squared is almost null, we can say that os version is not explaining the model
```
##### Testing linear regression for predicting lifetime
```{r}
# estimate relationship betwwen lifetime and no of websites visites
library(ggplot2)
g = ggplot(TrainData, aes(x = no_website , y = range))
g = g + xlab("No of websites")
g = g + ylab("Lifetime")
g = g + geom_point(size = 5, colour = "black", alpha=0.5)
g = g + geom_point(size = 3, colour = "blue", alpha=0.2)
g = g + geom_smooth(method = "lm", colour = "black")
g

fit <- lm(range ~ no_website, data = TrainData)
coef(fit)
# we expect 1 day increase in lifetime for each new website visit

fit2 <- lm(range ~ active_features, data = TrainData)
coef(fit2)
# there is almost no influence between lifetime and no of time a features has been active

fit3 <- lm(range ~ no_events, data = TrainData)
coef(fit3)
# there is almost no influence between lifetime and no of time a features has been active

TestData <- read.csv("test.csv", header = T)
TestData <- TestData[!(TestData$os=='NULL'),]
#adding os version
TestData$os_version <- as.factor(substrLast(as.character(TestData$os), 2))

TestData$rangePredict <- predict(fit, newdata = data.frame(no_website = TestData$no_website))
head(TestData)
```

#### Findings
* 50% of the users have a lifetime under 6 days
* The majority of users have win version 4 and 5
* Win 4,5 and 6 have the highest lifetime
* there is a positive relationship between no of websites visited and no of active features
* Clustering the users in 5 groups, we can notice that there is a positive relationship between active features and lifetime
* There is a strong correlation between the no of websites visited, active features and the no of total events
* The feature that has the largest correlation with lifetime, between no of websites visited, no of events and active features, is no of websites.

#### Further work
* check a non linear model like logistic regression, use 2nd or 3rd power of the current features 
* aggregate different features
  + daily average active features
  + daily average no of events
  + min/max monthly no of events
  + min/max monthly no of websites
  + no of websites/no of events (monthly and daily)
  + others like the one above
* consider range a categorical variable and split it into groups; build a decision tree (CHAID)
